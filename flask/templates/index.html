<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bsky Realtime Analyser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-3xl mx-auto bg-white p-6 shadow-lg rounded-lg">
        <h1 class="text-2xl font-bold mb-4">Bsky Realtime Analyser</h1>
        <button id="start-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Iniciar Captura</button>
        <button id="stop-btn" class="bg-yellow-500 text-white px-4 py-2 ml-2 rounded hover:bg-yellow-600" style="display: none;">Parar Coleta</button>
        <button id="reset-btn" class="bg-red-500 text-white px-4 py-2 ml-2 rounded hover:bg-red-600">Reiniciar</button>

        <div class="mt-6" id="spinner" style="display: none;">
            <p class="text-blue-500">Coletando dados... Aguarde.</p>
        </div>

        <div class="mt-6" id="data-display" style="display: none;">
            <h2 class="text-xl font-semibold">Postagens Coletadas:</h2>
            <div id="posts" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <script>
        const socket = io();

        document.getElementById('start-btn').addEventListener('click', () => {
            console.log("Clique em INICIAR CAPTURA");
            document.getElementById('spinner').style.display = 'block';
            document.getElementById('data-display').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';

            fetch('/start').then(response => response.json()).then(data => {
                console.log("Coleta iniciada", data);
            });
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            console.log("Clique em PARAR COLETA");
            fetch('/stop').then(response => response.json()).then(() => {
                socket.emit('collection_complete');
            });
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            console.log("Clique em REINICIAR");
            fetch('/reset').then(() => {
                document.getElementById('posts').innerHTML = '';
                document.getElementById('data-display').style.display = 'none';
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'none';
            });
        });

        socket.on('collection_complete', () => {
            console.log("Evento collection_complete recebido");
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('data-display').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';

            fetch('/data').then(response => response.json()).then(posts => {
                const postsContainer = document.getElementById('posts');
                postsContainer.innerHTML = '';
                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = "bg-gray-200 p-2 rounded mb-2";
                    postElement.innerHTML = `
                        <p><strong>Autor:</strong> ${post.author}</p>
                        <p><strong>Data:</strong> ${post.created_at}</p>
                        <p>${post.text}</p>
                    `;
                    postsContainer.appendChild(postElement);
                });
            });
        });
    </script>
</body>
</html>
